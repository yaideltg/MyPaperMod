<!--This snippet has been taken from the Logseq-Schrodinger project at
https://github.com/sawhney17/logseq-schrodinger. It basically takes the name of the current note, and searches
for it in the content of all other notes in the blog (under the folder /content/posts in this case, set by
"Type" "posts"). If it finds that there is another note with the name of this note's file on its body, it
means that there is a backlink, and then it adds that note's link to the list $backlinks. Finally, the list of
backlinks is printed wherever you want it to be.-->

<!--Because I have a multilingual site, if I would use $re := .File.BaseFileName, it would result in $re being
equal to test-post.en, for example. This is not desirable, because when we make a reference between posts, we
don't include the language code of the notes. For this reason it is important to remove the language code from
the nale of the note.-->

<!-- variable re gets the name of the current post -->
{{ $re := "" }}
{{ with .File }}
<!-- If we are in a Leaf Bundle the "index" file means nothing for backlinking, therefore we need the ContentBaseName (see https://gohugo.io/variables/files/#examples) -->
    {{ if (eq .TranslationBaseName "index") }}
        {{ $re = .ContentBaseName }}
<!-- I want to skip the Branch Bundle pages, as they are not made for content and will not have backlinks -->
    {{ else if (eq .TranslationBaseName "_index") }}
        {{ $re = "BranchBundle" }}
<!-- Finally, if it is a regular content page, just take its translational name, without lang extension -->
    {{ else }}
        {{- $re = .TranslationBaseName -}}
    {{ end }}
{{ end }}

{{- $backlinks := slice -}}
{{ if (ne $re "BranchBundle") }}
{{- range (where .Site.RegularPages "Section" "posts") -}}
    {{ if (eq .File.TranslationBaseName "index") }}
        {{- if and (findRE $re .RawContent) (not (eq $re .File.ContentBaseName)) -}} {{ $backlinks = $backlinks | append . }} {{- end -}}
    {{ else }}
        {{- if and (findRE $re .RawContent) (not (eq $re .File.TranslationBaseName)) -}} {{ $backlinks = $backlinks | append . }} {{- end -}}
    {{ end }}
{{- end -}}
{{- end -}}

{{- if and (gt (len $backlinks) 0) (ne .Page.Kind "term") (ne .Page.Kind "taxonomy") -}}
<h1>Backlinks</h1>
<div class="BackLinkDiv">
  <ul id="BackLinkList">
    {{ range $backlinks }}
    <li><a href="{{ .RelPermalink }}">{{ .Title }}</a></li>
    {{ end }}
  </ul>
</div>
{{- end -}}
